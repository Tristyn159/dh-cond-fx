<div class="dce-config-body">

  <fieldset class="dce-fieldset">
    <legend>Basic Info</legend>
    <div class="dce-fieldset-inner">
      <div class="dce-form-row">
        <label>Name</label>
        <input type="text" name="name" value="{{effect.name}}" required />
      </div>
      <div class="dce-form-row">
        <label>Description</label>
        <input type="text" name="description" value="{{effect.description}}" placeholder="Optional note" />
      </div>
      <div class="dce-form-row">
        <label>Enabled</label>
        <select name="enabled">
          <option value="true"  {{#if (eq enabledStr "true")}} selected{{/if}}>Yes</option>
          <option value="false" {{#if (eq enabledStr "false")}}selected{{/if}}>No</option>
        </select>
      </div>
      <div class="dce-form-row dce-field-applyto {{#unless showApplyTo}}dce-hidden{{/unless}}">
        <label>Applies to
          <span class="dce-hint-icon" title="Self: this effect applies when the owner acts (attacks, rolls). Incoming: applies when others target the owner.">
            <i class="fas fa-circle-question"></i>
          </span>
        </label>
        <select name="effect.applyTo">
          {{#each applyTargets}}
          <option value="{{id}}" {{#if (eq ../effect.effect.applyTo id)}}selected{{/if}}>{{label}}</option>
          {{/each}}
        </select>
      </div>
    </div>
  </fieldset>

  <fieldset class="dce-fieldset">
    <legend>Condition — when does it apply?</legend>
    <div class="dce-fieldset-inner">

      <div class="dce-form-row">
        <label>Condition Type</label>
        <select name="condition.type">
          {{#each conditionTypes}}
          <option value="{{id}}" {{#if (eq ../effect.condition.type id)}}selected{{/if}}>{{label}}</option>
          {{/each}}
        </select>
      </div>

      <div class="dce-form-row dce-field-subject {{#unless showSubject}}dce-hidden{{/unless}}">
        <label>Check on
          <span class="dce-hint-icon" title="Self = the item's owner. Target = whoever the owner is targeting.">
            <i class="fas fa-circle-question"></i>
          </span>
        </label>
        <select name="condition.subject">
          <option value="self"   {{#if (eq effect.condition.subject "self")}}  selected{{/if}}>Self (item owner)</option>
          <option value="target" {{#if (eq effect.condition.subject "target")}}selected{{/if}}>Target</option>
        </select>
      </div>

      <div class="dce-form-row dce-field-status {{#unless showStatus}}dce-hidden{{/unless}}">
        <label>Status / Condition</label>
        <select name="condition.status">
          {{#each statuses}}
          <option value="{{id}}" {{#if (eq ../effect.condition.status id)}}selected{{/if}}>{{label}}</option>
          {{/each}}
        </select>
      </div>

      <div class="dce-field-attribute {{#unless showAttribute}}dce-hidden{{/unless}}">
        <div class="dce-form-row">
          <label>Attribute</label>
          <select name="condition.attribute">
            {{#each attributes}}
            <option value="{{id}}" {{#if (eq ../effect.condition.attribute id)}}selected{{/if}}>{{label}}</option>
            {{/each}}
          </select>
        </div>
        <div class="dce-form-row">
          <label>Operator</label>
          <select name="condition.operator">
            {{#each operators}}
            <option value="{{id}}" {{#if (eq ../effect.condition.operator id)}}selected{{/if}}>{{label}}</option>
            {{/each}}
          </select>
        </div>
        <div class="dce-form-row">
          <label>Value</label>
          <input type="number" name="condition.value" value="{{effect.condition.value}}" step="1" />
        </div>
      </div>

      <div class="dce-field-range {{#unless showRange}}dce-hidden{{/unless}}">
        <div class="dce-form-row">
          <label>Range Mode
            <span class="dce-hint-icon" title="Within = at or closer. At = exactly that range band. Further Than = beyond that range.">
              <i class="fas fa-circle-question"></i>
            </span>
          </label>
          <select name="condition.rangeMode">
            {{#each rangeModes}}
            <option value="{{id}}" {{#if (eq ../effect.condition.rangeMode id)}}selected{{/if}}>{{label}}</option>
            {{/each}}
          </select>
        </div>
        <div class="dce-form-row">
          <label>Range Band</label>
          <select name="condition.range">
            {{#each rangeTypes}}
            <option value="{{id}}" {{#if (eq ../effect.condition.range id)}}selected{{/if}}>{{label}}</option>
            {{/each}}
          </select>
        </div>
        <div class="dce-form-row">
          <label>Check Against
            <span class="dce-hint-icon" title="Target = your current Foundry target(s). Friends/Enemies = tokens by disposition on the scene.">
              <i class="fas fa-circle-question"></i>
            </span>
          </label>
          <select name="condition.rangeSubject">
            {{#each rangeSubjects}}
            <option value="{{id}}" {{#if (eq ../effect.condition.rangeSubject id)}}selected{{/if}}>{{label}}</option>
            {{/each}}
          </select>
        </div>
        <div class="dce-form-row dce-field-range-count {{#unless showRangeCount}}dce-hidden{{/unless}}">
          <label>Minimum Count
            <span class="dce-hint-icon" title="How many tokens of that type must be in range for the condition to be met.">
              <i class="fas fa-circle-question"></i>
            </span>
          </label>
          <input type="number" name="condition.rangeCount" value="{{effect.condition.rangeCount}}" step="1" min="1" />
        </div>
      </div>

      <div class="dce-form-row dce-field-weapon-slot {{#unless showWeaponSlot}}dce-hidden{{/unless}}">
        <label>Weapon Slot</label>
        <select name="condition.weaponSlot">
          {{#each weaponSlots}}
          <option value="{{id}}" {{#if (eq ../effect.condition.weaponSlot id)}}selected{{/if}}>{{label}}</option>
          {{/each}}
        </select>
      </div>

      <div class="dce-form-row dce-field-incoming-damage-type {{#unless showIncomingDamageType}}dce-hidden{{/unless}}">
        <label>Damage Type
          <span class="dce-hint-icon" title="Match a specific incoming damage type, or Any to match all.">
            <i class="fas fa-circle-question"></i>
          </span>
        </label>
        <select name="condition.incomingDamageType">
          {{#each incomingDamageTypes}}
          <option value="{{id}}" {{#if (eq ../effect.condition.incomingDamageType id)}}selected{{/if}}>{{label}}</option>
          {{/each}}
        </select>
      </div>

      <div class="dce-form-row dce-field-threshold {{#unless showThreshold}}dce-hidden{{/unless}}">
        <label>Threshold</label>
        <select name="condition.threshold">
          {{#each damageThresholds}}
          <option value="{{id}}" {{#if (eq ../effect.condition.threshold id)}}selected{{/if}}>{{label}}</option>
          {{/each}}
        </select>
      </div>

    </div>
  </fieldset>

  <fieldset class="dce-fieldset">
    <legend>Duration — when does it expire?</legend>
    <div class="dce-fieldset-inner">
      <div class="dce-form-row">
        <label>Duration</label>
        <select name="duration.mode">
          {{#each durationModes}}
          <option value="{{id}}" {{#if (eq ../durationMode id)}}selected{{/if}}>{{label}}</option>
          {{/each}}
        </select>
      </div>

      <div class="dce-form-row dce-field-duration-uses {{#unless showDurationUses}}dce-hidden{{/unless}}">
        <label>Uses</label>
        <input type="number" name="duration.uses" value="{{durationUses}}" step="1" min="1" />
      </div>

      <div class="dce-field-countdown {{#unless showCountdown}}dce-hidden{{/unless}}">
        <div class="dce-form-row">
          <label>Countdown Ticks
            <span class="dce-hint-icon" title="Number of ticks before the effect expires. Each event decrements by 1.">
              <i class="fas fa-circle-question"></i>
            </span>
          </label>
          <input type="number" name="duration.countdownTicks" value="{{effect.duration.countdownTicks}}" step="1" min="1" />
        </div>
        <div class="dce-form-row">
          <label>Tick On
            <span class="dce-hint-icon" title="What event decrements the countdown.">
              <i class="fas fa-circle-question"></i>
            </span>
          </label>
          <select name="duration.countdownTickOn">
            {{#each countdownTickEvents}}
            <option value="{{id}}" {{#if (eq ../effect.duration.countdownTickOn id)}}selected{{/if}}>{{label}}</option>
            {{/each}}
          </select>
        </div>
      </div>

      <p class="dce-help">
        <em>Note:</em> Duration is consumed when the effect actually applies. For "Next Roll" / "Next Hit", it is only consumed by roll- or damage-related effect types.
      </p>
    </div>
  </fieldset>

  <fieldset class="dce-fieldset">
    <legend>Effect — what does it do?</legend>
    <div class="dce-fieldset-inner">

      <div class="dce-form-row">
        <label>Effect Type</label>
        <select name="effect.type">
          {{#each effectTypes}}
          <option value="{{id}}" {{#if (eq ../effect.effect.type id)}}selected{{/if}}>{{label}}</option>
          {{/each}}
        </select>
      </div>

      {{!-- Damage bonus --}}
      <div class="dce-field-damage-bonus {{#unless showDamageBonus}}dce-hidden{{/unless}}">
        <div class="dce-form-row">
          <label>Damage Type</label>
          <select name="effect.damageType">
            {{#each damageTypes}}
            <option value="{{id}}" {{#if (eq ../effect.effect.damageType id)}}selected{{/if}}>{{label}}</option>
            {{/each}}
          </select>
        </div>
        <div class="dce-form-row">
          <label>Extra Dice <span class="dce-hint-icon" title="e.g. 1d6 or 2d4"><i class="fas fa-circle-question"></i></span></label>
          <input type="text" name="effect.dice" value="{{effect.effect.dice}}" placeholder="e.g. 1d6" />
        </div>
        <div class="dce-form-row">
          <label>Flat Bonus</label>
          <input type="number" name="effect.bonus" value="{{effect.effect.bonus}}" step="1" />
        </div>
      </div>

      {{!-- Damage multiplier --}}
      <div class="dce-field-damage-multiplier {{#unless showDamageMultiplier}}dce-hidden{{/unless}}">
        <div class="dce-form-row">
          <label>Damage Type
            <span class="dce-hint-icon" title="Only multiply incoming damage of this type. Use 'Any' to apply to all damage.">
              <i class="fas fa-circle-question"></i>
            </span>
          </label>
          <select name="effect.incomingDamageType">
            {{#each incomingDamageTypes}}
            <option value="{{id}}" {{#if (eq ../effect.effect.incomingDamageType id)}}selected{{/if}}>{{label}}</option>
            {{/each}}
          </select>
        </div>
        <div class="dce-form-row">
          <label>Multiplier
            <span class="dce-hint-icon" title="e.g. 2 = double damage, 0.5 = half damage. Applied before damage thresholds are calculated.">
              <i class="fas fa-circle-question"></i>
            </span>
          </label>
          <input type="number" name="effect.damageMultiplier" value="{{effect.effect.damageMultiplier}}" step="0.1" min="0" />
        </div>
      </div>

      {{!-- Damage threshold bonus --}}
      <div class="dce-field-damage-reduction {{#unless showDamageReduction}}dce-hidden{{/unless}}">
        <div class="dce-form-row">
          <label>Major Threshold Bonus
            <span class="dce-hint-icon" title="Added to the actor's Major damage threshold (system.damageThresholds.major).">
              <i class="fas fa-circle-question"></i>
            </span>
          </label>
          <input type="number" name="effect.thresholdMajor" value="{{effect.effect.thresholdMajor}}" step="1" />
        </div>
        <div class="dce-form-row">
          <label>Severe Threshold Bonus
            <span class="dce-hint-icon" title="Added to the actor's Severe damage threshold (system.damageThresholds.severe).">
              <i class="fas fa-circle-question"></i>
            </span>
          </label>
          <input type="number" name="effect.thresholdSevere" value="{{effect.effect.thresholdSevere}}" step="1" />
        </div>
      </div>

      {{!-- Defense / evasion bonus --}}
      <div class="dce-field-defense-bonus {{#unless showDefenseBonus}}dce-hidden{{/unless}}">
        <div class="dce-form-row">
          <label>Evasion Bonus (flat)
            <span class="dce-hint-icon" title="Added to the reaction/fate roll for evasion.">
              <i class="fas fa-circle-question"></i>
            </span>
          </label>
          <input type="number" name="effect.defenseBonus" value="{{effect.effect.defenseBonus}}" step="1" />
        </div>
      </div>

      {{!-- Status on hit --}}
      <div class="dce-field-status-on-hit {{#unless showStatusOnHit}}dce-hidden{{/unless}}">
        <div class="dce-form-row">
          <label>Status to Apply</label>
          <select name="effect.statusToApply">
            {{#each statuses}}
            <option value="{{id}}" {{#if (eq ../effect.effect.statusToApply id)}}selected{{/if}}>{{label}}</option>
            {{/each}}
          </select>
        </div>
      </div>

      {{!-- Proficiency bonus --}}
      <div class="dce-field-proficiency-bonus {{#unless showProficiencyBonus}}dce-hidden{{/unless}}">
        <div class="dce-form-row">
          <label>Proficiency Bonus
            <span class="dce-hint-icon" title="Added to the actor's Proficiency while the condition is met. Applied via ActiveEffect.">
              <i class="fas fa-circle-question"></i>
            </span>
          </label>
          <input type="number" name="effect.proficiencyBonus" value="{{effect.effect.proficiencyBonus}}" step="1" />
        </div>
      </div>

      {{!-- Stress on hit --}}
      <div class="dce-field-stress-on-hit {{#unless showStressOnHit}}dce-hidden{{/unless}}">
        <div class="dce-form-row">
          <label>Stress Amount
            <span class="dce-hint-icon" title="The number of Stress to apply to the target when damage is dealt.">
              <i class="fas fa-circle-question"></i>
            </span>
          </label>
          <input type="number" name="effect.stressAmount" value="{{effect.effect.stressAmount}}" step="1" min="1" />
        </div>
      </div>

      {{!-- Apply status while condition met --}}
      <div class="dce-field-apply-status {{#unless showApplyStatus}}dce-hidden{{/unless}}">
        <div class="dce-form-row">
          <label>Status to Apply
            <span class="dce-hint-icon" title="This status is applied to the subject while the condition is met, and removed (deleted) when the condition is no longer met.">
              <i class="fas fa-circle-question"></i>
            </span>
          </label>
          <select name="effect.applyStatus">
            {{#each statuses}}
            <option value="{{id}}" {{#if (eq ../effect.effect.applyStatus id)}}selected{{/if}}>{{label}}</option>
            {{/each}}
          </select>
        </div>
      </div>

      {{!-- Roll bonus --}}
      <div class="dce-field-roll-bonus {{#unless showRollBonus}}dce-hidden{{/unless}}">
        <div class="dce-form-row">
          <label>Roll Bonus (flat)
            <span class="dce-hint-icon" title="Added to the duality/d20 roll total.">
              <i class="fas fa-circle-question"></i>
            </span>
          </label>
          <input type="number" name="effect.rollBonus" value="{{effect.effect.rollBonus}}" step="1" />
        </div>
      </div>

      {{!-- Roll filters (trait + action type) — shown for roll_bonus, advantage, disadvantage --}}
      <div class="dce-field-roll-filters {{#unless showRollFilters}}dce-hidden{{/unless}}">
        <div class="dce-form-row">
          <label>Trait Filter
            <span class="dce-hint-icon" title="Only apply to rolls using this trait. 'Any Trait' applies to all rolls.">
              <i class="fas fa-circle-question"></i>
            </span>
          </label>
          <select name="effect.traitFilter">
            {{#each traits}}
            <option value="{{id}}" {{#if (eq ../effect.effect.traitFilter id)}}selected{{/if}}>{{label}}</option>
            {{/each}}
          </select>
        </div>
        <div class="dce-form-row">
          <label>Roll Type Filter
            <span class="dce-hint-icon" title="Only apply to action rolls, reaction rolls, or any roll.">
              <i class="fas fa-circle-question"></i>
            </span>
          </label>
          <select name="effect.actionTypeFilter">
            {{#each actionRollTypes}}
            <option value="{{id}}" {{#if (eq ../effect.effect.actionTypeFilter id)}}selected{{/if}}>{{label}}</option>
            {{/each}}
          </select>
        </div>
      </div>

    </div>
  </fieldset>

  <fieldset class="dce-fieldset">
    <legend>Chains — also trigger these effects
      <span class="dce-hint-icon" title="When this effect fires, also trigger the chained effects. Max depth: 3.">
        <i class="fas fa-circle-question"></i>
      </span>
    </legend>
    <div class="dce-fieldset-inner">
      <div class="dce-chain-tags" data-chain-container>
        {{#each chainableEffects}}
          {{#if selected}}
          <span class="dce-chain-tag" data-chain-id="{{id}}">
            <input type="hidden" name="effect.chainEffectIds" value="{{id}}">
            {{name}}
            <button type="button" class="dce-chain-tag-remove" data-action="removeChain" title="Remove chain">
              <i class="fas fa-xmark"></i>
            </button>
          </span>
          {{/if}}
        {{/each}}
        {{#unless hasChains}}
          <em class="dce-chain-empty">No chained effects</em>
        {{/unless}}
      </div>
      <button type="button" class="dce-btn-secondary" data-action="openChainPicker">
        <i class="fas fa-link"></i> Chain Effects&hellip;
      </button>
    </div>
  </fieldset>

  <div class="dce-form-footer">
    <button type="submit" class="dce-btn-primary">
      <i class="fas fa-save"></i> Save Effect
    </button>
  </div>

</div>
